name: deploy

on:
  workflow_run:
    workflows: ["deploy-manifest"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Deploy environment (requires approval for prod)."
        options:
          - staging
          - prod
        default: staging
      rev:
        type: string
        description: "Optional pinned 40-hex rev (deploys /deploy/<host>/<rev>.json)."
        required: false
      host:
        type: string
        description: "Optional single host to deploy (default: all)."
        required: false

permissions:
  contents: read

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 22

      - name: Verify manifest public key configured
        run: |
          set -euo pipefail
          key="$(cat config/manifest.minisign.pub)"
          if [[ -z "${key}" || "${key}" == "CHANGE_ME_MINISIGN_PUBLIC_KEY" ]]; then
            echo "error: config/manifest.minisign.pub is still the placeholder"
            exit 1
          fi

      - name: Read CLI version
        id: cli
        run: |
          set -euo pipefail
          version="$(cat config/clawdlets-cli-version.txt)"
          if [[ -z "${version}" ]]; then
            echo "error: config/clawdlets-cli-version.txt is empty"
            exit 1
          fi
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Install clawdlets CLI
        run: npm install -g clawdlets@${{ steps.cli.outputs.version }}

      - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31.9.0
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install minisign
        run: |
          set -euo pipefail
          nix profile install nixpkgs#minisign
          echo "${HOME}/.nix-profile/bin" >> "$GITHUB_PATH"

      - name: Configure SSH
        run: |
          set -euo pipefail
          install -d -m 700 ~/.ssh
          printf '%s' "${DEPLOY_SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          : > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          cat > ~/.ssh/config <<'EOF'
          Host *
            StrictHostKeyChecking yes
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Join tailnet
        uses: tailscale/github-action@4e4c49acaa9818630ce0bd7a564372c17e33fb4d # v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: clawdlets-ci-${{ github.run_id }}

      - name: Deploy
        env:
          HOST_FILTER: ${{ github.event_name == 'workflow_dispatch' && inputs.host || '' }}
          REV_FILTER: ${{ github.event_name == 'workflow_dispatch' && inputs.rev || '' }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          owner="${repo%%/*}"
          name="${repo##*/}"
          pages_base="https://${owner}.github.io/${name}"

          if [[ -n "${REV_FILTER}" && ! "${REV_FILTER}" =~ ^[0-9a-f]{40}$ ]]; then
            echo "error: inputs.rev must be a full 40-hex sha"
            exit 2
          fi

          jq -r '.hosts | keys[]' fleet/clawdlets.json | while IFS= read -r host; do
            [[ -z "${host}" ]] && continue
            if [[ -n "${HOST_FILTER}" && "${host}" != "${HOST_FILTER}" ]]; then
              continue
            fi
            known_count=$(jq -r --arg host "${host}" '.hosts[$host].sshKnownHosts | length' fleet/clawdlets.json)
            if [[ "${known_count}" -le 0 ]]; then
              echo "error: hosts.${host}.sshKnownHosts missing (add pinned known_hosts entry)"
              exit 2
            fi
            jq -r --arg host "${host}" '.hosts[$host].sshKnownHosts[]' fleet/clawdlets.json >> ~/.ssh/known_hosts
            manifest="deploy-manifest.${host}.json"
            manifest_url=""
            if [[ -n "${REV_FILTER}" ]]; then
              manifest_url="${pages_base}/deploy/${host}/${REV_FILTER}.json"
            else
              manifest_url="${pages_base}/deploy/${host}/latest.json"
            fi
            curl -fsSL --retry 3 --retry-delay 2 -o "${manifest}" "${manifest_url}"
            curl -fsSL --retry 3 --retry-delay 2 -o "${manifest}.minisig" "${manifest_url}.minisig"
            clawdlets server deploy \
              --host "${host}" \
              --manifest "${manifest}" \
              --manifest-signature "${manifest}.minisig" \
              --manifest-public-key-file config/manifest.minisign.pub \
              --ssh-tty false
          done
